<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laivojen reaaliaikainen sijainti</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 15px;
      }

      #map {
        flex: 1;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        min-height: 400px;
      }

      .info-panel {
        background: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .ship-info {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .info-item {
        flex: 1;
        min-width: 150px;
      }

      .info-label {
        font-weight: bold;
        color: #666;
      }

      .info-value {
        font-size: 1.2em;
        color: #333;
        margin-top: 5px;
      }

      .speed {
        color: #007bff;
      }

      .ship-number {
        color: #28a745;
      }

      button {
        margin-top: 10px;
        margin-right: 10px;
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #0056b3;
      }

      #result {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Laivojen reaaliaikainen sijainti</h1>

    <div class="info-panel">
      <div class="ship-info">
        <div class="info-item">
          <div class="info-label">Valittu Laiva:</div>
          <div class="info-value ship-number" id="shipNumber">
            Kaikki laivat
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">Nopeus:</div>
          <div class="info-value speed" id="speed">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">Sijainti:</div>
          <div class="info-value" id="coordinates">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">P√§ivitetty:</div>
          <div class="info-value" id="timestamp">-</div>
        </div>
      </div>

      <button onclick="showAllShipss()">N√§yt√§ kaikki laivat</button>
      <button onclick="showShipCount()">N√§yt√§ laivojen m√§√§r√§</button>
      <button onclick="showFastestShips()">N√§yt√§ nopeimmat</button>

      <div id="result"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      const map = L.map("map").setView([64.5, 26.5], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);

      let shipMarkers = [];
      let selectedShip = null;

      function createShipIcon(mmsi, isSelected = false) {
        const color = isSelected ? "#dc3545" : "#007bff";
        const size = isSelected ? 35 : 25;
        const content = isSelected ? "üö¢" : mmsi;

        return L.divIcon({
          className: "ship-marker",
          html: `
            <div style="
                background: ${color};
                color: white;
                border-radius: 50%;
                width: ${size}px;
                height: ${size}px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: ${isSelected ? "16px" : "10px"};
                border: 3px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                cursor: pointer;
            ">${content}</div>
          `,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2],
        });
      }

      function updateSelectedShipInfo(ship) {
        const coords = ship.location.coordinates;
        const lat = coords[1];
        const lng = coords[0];

        document.getElementById("shipNumber").textContent = `Laiva ${ship.mmsi}`;
        document.getElementById("speed").textContent = ship.speed + " km/h";
        document.getElementById("coordinates").textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        const timestamp = new Date(ship.timestamp);
        document.getElementById("timestamp").textContent = timestamp.toLocaleString("fi-FI");

        updateSpeedColor(ship.speed);
      }

      function displayAllShips(ships) {
        if (selectedShip) return;

        shipMarkers.forEach((marker) => map.removeLayer(marker));
        ship = [];

        ships.forEach((ship) => {
          const coords = ship.location.coordinates;
          const lat = coords[1];
          const lng = coords[0];

          const marker = L.marker([lat, lng], {
            icon: createShipIcon(ship.mmsi, false),
          }).addTo(map);

          const timestamp = new Date(ship.timestamp);
          marker.bindPopup(`
            <strong>Laiva ${ship.mmsi}</strong><br>
            Nopeus: ${ship.speed} km/h<br>
            Tarkkuus: ${ship.accuracy} m<br>
            P√§ivitetty: ${timestamp.toLocaleTimeString("fi-FI")}
          `);

          marker.on("click", function () {
            selectShip(ship);
          });

          shipMarkers.push(marker);
        });
      }

      function selectShip(ship) {
        selectedShip = ship;
        const coords = ship.location.coordinates;
        const lat = coords[1];
        const lng = coords[0];

        shipMarkers.forEach((marker) => map.removeLayer(marker));
        shipMarkers = [];

        const marker = L.marker([lat, lng], {
          icon: createShipIcon(ship.mmsi, true),
        }).addTo(map);

        const timestamp = new Date(ship.timestamp);
        marker.bindPopup(`
          <strong>Laiva ${ship.mmsi}</strong><br>
          Nopeus: ${ship.speed} km/h<br>
          Tarkkuus: ${ship.accuracy} m<br>
          P√§ivitetty: ${timestamp.toLocaleTimeString("fi-FI")}
        `);

        shipMarkers.push(marker);

        setTimeout(() => {
          map.invalidateSize();
          map.setView([lat, lng], 13);
        }, 50);

        updateSelectedShipInfo(ship);
      }

      function showAllShips() {
        selectedShip = null;
        document.getElementById("shipNumber").textContent = "Kaikki laivat";
        document.getElementById("speed").textContent = "-";
        document.getElementById("coordinates").textContent = "-";
        document.getElementById("timestamp").textContent = "-";
        document.getElementById("result").style.display = "none";

        map.setView([64.5, 26.5], 6);
        fetchAllShips().then(displayAllShips);
      }

      function fetchAllShips() {
        return fetch("http://localhost:3000/api/ships").then((response) =>
          response.json()
        );
      }

      function updateSpeedColor(speed) {
        const speedElement = document.getElementById("speed");
        if (speed < 20) {
          speedElement.style.color = "#dc3545";
        } else if (speed < 80) {
          speedElement.style.color = "#ffc107";
        } else {
          speedElement.style.color = "#28a745";
        }
      }

      // TEHT√ÑV√Ñ 1: N√§yt√§ laivam√§√§r√§
      function showShipCount() {
        fetch("http://localhost:3000/api/ships/count")
          .then((response) => response.json())
          .then((data) => {
            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `<h3>Laivoja yhteens√§: ${data.count} kpl</h3>`;
            resultDiv.style.display = "block";
          })
          .catch((error) => {
            console.error("Virhe:", error);
            alert("Virhe! Tarkista ett√§ backend on k√§ynniss√§ ja endpoint /api/ships/count on tehty.");
          });
      }

      // TEHT√ÑV√Ñ 2: N√§yt√§ nopeimmat laivat
      function showFastestShips() {
        fetch("http://localhost:3000/api/ships/fastest")
          .then((response) => response.json())
          .then((ships) => {
            const resultDiv = document.getElementById("result");
            let html = "<h3>Top 5 nopeinta laivaa:</h3>";
            ships.forEach((ship, index) => {
              html += `<p>${index + 1}. Laiva ${ship.mmsi} - ${ship.speed} km/h</p>`;
            });
            resultDiv.innerHTML = html;
            resultDiv.style.display = "block";
          })
          .catch((error) => {
            console.error("Virhe:", error);
            alert("Virhe! Tarkista ett√§ backend on k√§ynniss√§ ja endpoint /api/ships/fastest on tehty.");
          });
      }

      // K√§ynnist√§ sovellus
      fetchAllShips().then((ships) => {
        if (ships.length > 0) {
          displayAllShips(ships);
          console.log(`Ladattu ${ships.length} laivaa kartalle`);
        } else {
          console.warn("Ei laivoja saatavilla.");
        }
      });

      // P√§ivit√§ laivojen sijainteja 30 sekunnin v√§lein
      setInterval(() => {
        fetchAllShips().then(displayAllShips);
      }, 30000);
    </script>
  </body>
</html>