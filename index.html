<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Junien reaaliaikainen sijainti</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 15px;
      }

      #map {
        flex: 1;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        min-height: 400px;
      }

      .info-panel {
        background: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .train-info {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .info-item {
        flex: 1;
        min-width: 150px;
      }

      .info-label {
        font-weight: bold;
        color: #666;
      }

      .info-value {
        font-size: 1.2em;
        color: #333;
        margin-top: 5px;
      }

      .speed {
        color: #007bff;
      }

      .train-number {
        color: #28a745;
      }

      button {
        margin-top: 10px;
        margin-right: 10px;
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #0056b3;
      }

      #result {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Junien reaaliaikainen sijainti</h1>

    <div class="info-panel">
      <div class="train-info">
        <div class="info-item">
          <div class="info-label">Valittu juna:</div>
          <div class="info-value train-number" id="trainNumber">
            Kaikki junat
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">Nopeus:</div>
          <div class="info-value speed" id="speed">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">Sijainti:</div>
          <div class="info-value" id="coordinates">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">P√§ivitetty:</div>
          <div class="info-value" id="timestamp">-</div>
        </div>
      </div>

      <button onclick="showAllTrains()">N√§yt√§ kaikki junat</button>
      <button onclick="showTrainCount()">N√§yt√§ junam√§√§r√§</button>
      <button onclick="showFastestTrains()">N√§yt√§ nopeimmat</button>

      <div id="result"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      const map = L.map("map").setView([64.5, 26.5], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);

      let trainMarkers = [];
      let selectedTrain = null;

      function createTrainIcon(trainNumber, isSelected = false) {
        const color = isSelected ? "#dc3545" : "#007bff";
        const size = isSelected ? 35 : 25;
        const content = isSelected ? "üöÇ" : trainNumber;

        return L.divIcon({
          className: "train-marker",
          html: `
            <div style="
                background: ${color};
                color: white;
                border-radius: 50%;
                width: ${size}px;
                height: ${size}px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: ${isSelected ? "16px" : "10px"};
                border: 3px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                cursor: pointer;
            ">${content}</div>
          `,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2],
        });
      }

      function updateSelectedTrainInfo(train) {
        const coords = train.location.coordinates;
        const lat = coords[1];
        const lng = coords[0];

        document.getElementById("trainNumber").textContent = `Juna ${train.trainNumber}`;
        document.getElementById("speed").textContent = train.speed + " km/h";
        document.getElementById("coordinates").textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        const timestamp = new Date(train.timestamp);
        document.getElementById("timestamp").textContent = timestamp.toLocaleString("fi-FI");

        updateSpeedColor(train.speed);
      }

      function displayAllTrains(trains) {
        if (selectedTrain) return;

        trainMarkers.forEach((marker) => map.removeLayer(marker));
        trainMarkers = [];

        trains.forEach((train) => {
          const coords = train.location.coordinates;
          const lat = coords[1];
          const lng = coords[0];

          const marker = L.marker([lat, lng], {
            icon: createTrainIcon(train.trainNumber, false),
          }).addTo(map);

          const timestamp = new Date(train.timestamp);
          marker.bindPopup(`
            <strong>Juna ${train.trainNumber}</strong><br>
            Nopeus: ${train.speed} km/h<br>
            Tarkkuus: ${train.accuracy} m<br>
            P√§ivitetty: ${timestamp.toLocaleTimeString("fi-FI")}
          `);

          marker.on("click", function () {
            selectTrain(train);
          });

          trainMarkers.push(marker);
        });
      }

      function selectTrain(train) {
        selectedTrain = train;
        const coords = train.location.coordinates;
        const lat = coords[1];
        const lng = coords[0];

        trainMarkers.forEach((marker) => map.removeLayer(marker));
        trainMarkers = [];

        const marker = L.marker([lat, lng], {
          icon: createTrainIcon(train.trainNumber, true),
        }).addTo(map);

        const timestamp = new Date(train.timestamp);
        marker.bindPopup(`
          <strong>Juna ${train.trainNumber}</strong><br>
          Nopeus: ${train.speed} km/h<br>
          Tarkkuus: ${train.accuracy} m<br>
          P√§ivitetty: ${timestamp.toLocaleTimeString("fi-FI")}
        `);

        trainMarkers.push(marker);

        setTimeout(() => {
          map.invalidateSize();
          map.setView([lat, lng], 13);
        }, 50);

        updateSelectedTrainInfo(train);
      }

      function showAllTrains() {
        selectedTrain = null;
        document.getElementById("trainNumber").textContent = "Kaikki junat";
        document.getElementById("speed").textContent = "-";
        document.getElementById("coordinates").textContent = "-";
        document.getElementById("timestamp").textContent = "-";
        document.getElementById("result").style.display = "none";

        map.setView([64.5, 26.5], 6);
        fetchAllTrains().then(displayAllTrains);
      }

      function fetchAllTrains() {
        return fetch("http://localhost:3000/api/trains").then((response) =>
          response.json()
        );
      }

      function updateSpeedColor(speed) {
        const speedElement = document.getElementById("speed");
        if (speed < 20) {
          speedElement.style.color = "#dc3545";
        } else if (speed < 80) {
          speedElement.style.color = "#ffc107";
        } else {
          speedElement.style.color = "#28a745";
        }
      }

      // TEHT√ÑV√Ñ 1: N√§yt√§ junam√§√§r√§
      function showTrainCount() {
        fetch("http://localhost:3000/api/trains/count")
          .then((response) => response.json())
          .then((data) => {
            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `<h3>Junia yhteens√§: ${data.count} kpl</h3>`;
            resultDiv.style.display = "block";
          })
          .catch((error) => {
            console.error("Virhe:", error);
            alert("Virhe! Tarkista ett√§ backend on k√§ynniss√§ ja endpoint /api/trains/count on tehty.");
          });
      }

      // TEHT√ÑV√Ñ 2: N√§yt√§ nopeimmat junat
      function showFastestTrains() {
        fetch("http://localhost:3000/api/trains/fastest")
          .then((response) => response.json())
          .then((trains) => {
            const resultDiv = document.getElementById("result");
            let html = "<h3>Top 5 nopeinta junaa:</h3>";
            trains.forEach((train, index) => {
              html += `<p>${index + 1}. Juna ${train.trainNumber} - ${train.speed} km/h</p>`;
            });
            resultDiv.innerHTML = html;
            resultDiv.style.display = "block";
          })
          .catch((error) => {
            console.error("Virhe:", error);
            alert("Virhe! Tarkista ett√§ backend on k√§ynniss√§ ja endpoint /api/trains/fastest on tehty.");
          });
      }

      // K√§ynnist√§ sovellus
      fetchAllTrains().then((trains) => {
        if (trains.length > 0) {
          displayAllTrains(trains);
          console.log(`Ladattu ${trains.length} junaa kartalle`);
        } else {
          console.warn("Ei junia saatavilla.");
        }
      });

      // P√§ivit√§ junien sijainteja 30 sekunnin v√§lein
      setInterval(() => {
        fetchAllTrains().then(displayAllTrains);
      }, 30000);
    </script>
  </body>
</html>